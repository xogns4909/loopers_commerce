resilience4j:
  # Circuit Breaker 설정
  circuitbreaker:
    instances:
      pg-client:
        failure-rate-threshold: 60          # 실패율 60% 이상 시 Circuit Open (50% → 60%)
        slow-call-rate-threshold: 70        # 느린 호출 70% 이상
        slow-call-duration-threshold: 2s    # 2초 이상을 느린 호출로 간주 (3s → 2s)
        minimum-number-of-calls: 10         # 최소 10회 호출 후 Circuit 상태 판단 (5 → 10)
        sliding-window-size: 20             # 20개 호출을 기준으로 슬라이딩 윈도우 (10 → 20)
        sliding-window-type: COUNT_BASED    # 개수 기반 윈도우
        wait-duration-in-open-state: 10s    # Circuit Open 후 10초 대기 (30s → 10s)
        permitted-number-of-calls-in-half-open-state: 5  # Half-Open에서 5회 시도 (3 → 5)
        automatic-transition-from-open-to-half-open-enabled: true
        
  # Retry 설정  
  retry:
    instances:
      pg-client:
        max-attempts: 2                     # 최대 2회 시도 (3 → 2, 빠른 실패)
        wait-duration: 500ms                # 500ms 간격 (1s → 500ms)
        exponential-backoff-multiplier: 2   # 지수 백오프 (500ms, 1s)
        randomized-delay-factor: 0.2        # ±20% 지터 추가
        retry-exceptions:
          - java.net.SocketTimeoutException
          - java.net.ConnectException
          - feign.RetryableException
          - java.net.SocketException
          - feign.FeignException.InternalServerError
          - feign.FeignException.BadGateway
          - feign.FeignException.ServiceUnavailable
          - feign.FeignException.GatewayTimeout
          - feign.FeignException.TooManyRequests
        ignore-exceptions:
          - feign.FeignException.BadRequest
          - feign.FeignException.Unauthorized
          - feign.FeignException.Forbidden
          - feign.FeignException.NotFound
          - feign.FeignException.UnprocessableEntity
          
  # Timeout 설정
  timelimiter:
    instances:
      pg-client:
        timeout-duration: 3s                # 전체 실행 시간 제한 (5s → 3s, 결제는 빨라야 함)
        cancel-running-future: true

  # Bulkhead 설정 (동시 실행 제한)
  bulkhead:
    instances:
      pg-client:
        max-concurrent-calls: 30            # 최대 30개 동시 호출 (20 → 30)
        max-wait-duration: 500ms            # 500ms 대기 (1s → 500ms)

# 메트릭 활성화
management:
  endpoints:
    web:
      exposure:
        include: health,info,metrics,circuitbreakers,retries,prometheus
  endpoint:
    health:
      show-details: always
  health:
    circuitbreakers:
      enabled: true
  metrics:
    export:
      prometheus:
        enabled: true
    distribution:
      percentiles-histogram:
        resilience4j.circuitbreaker.calls: true
        resilience4j.retry.calls: true
        http.server.requests: true

# 로깅 설정 (Resilience4j 디버깅용)
logging:
  level:
    io.github.resilience4j.circuitbreaker: DEBUG
    io.github.resilience4j.retry: DEBUG
    com.loopers.domain.payment.strategy: DEBUG
