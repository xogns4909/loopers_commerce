# ğŸ”„ ë¦¬íŒ©í† ë§ëœ ì£¼ë¬¸/ê²°ì œ í”Œë¡œìš° ì„¤ëª…

## ì „ì²´ ì•„í‚¤í…ì²˜ ê°œì„ ì‚¬í•­

### 1. **OrderFacade - ì£¼ë¬¸ ì²˜ë¦¬ ì§„ì…ì **
```java
public OrderResponse order(OrderCommand command) {
    // 1. ë©±ë“±ì„± ì²´í¬ - ê¸°ì¡´ ì£¼ë¬¸ì´ ìˆìœ¼ë©´ ë°˜í™˜
    return findExistingOrderResponse(command)
        .orElseGet(() -> createAndTriggerPayment(command));
}

private OrderResponse createAndTriggerPayment(OrderCommand command) {
    // 2. ì£¼ë¬¸ ìƒì„± íŠ¸ëœì­ì…˜ (ì¬ê³ ì°¨ê°/ì¿ í°ì ìš©/ì£¼ë¬¸ìƒì„±/ìš”ì²­ì ‘ìˆ˜)
    Order order = orderProcessor.process(command);
    
    // 3. ê²°ì œ íŠ¸ë¦¬ê±° (íŠ¸ëœì­ì…˜ ë°–ì—ì„œ)
    paymentService.pay(PaymentCommand.from(command, order));
    
    // 4. ìš”ì²­ ìˆ˜ë½ ê¸°ë¡
    orderRequestHistoryService.markAccepted(command.idempotencyKey());
    return new OrderResponse(order.getId(), order.getAmount().value(), order.getStatus());
}
```

### 2. **OrderProcessor - íŠ¸ëœì­ì…˜ ë‚´ ì£¼ë¬¸ ìƒì„±**
```java
@Transactional
public Order process(OrderCommand command) {
    // ì¬ê³  ì°¨ê° (ë™ì‹œì„± ì œì–´)
    productService.checkAndDeduct(command.items());
    
    // ì¿ í° ì ìš©
    BigDecimal finalAmount = couponService.apply(command.userId(), command.couponId(), originalAmount);
    
    // ì£¼ë¬¸ ìƒì„±
    Order order = orderService.createOrder(command.userId(), command.items(), OrderAmount.of(finalAmount));
    
    // ìš”ì²­ íˆìŠ¤í† ë¦¬: RECEIVED
    orderRequestHistoryService.saveReceived(command.idempotencyKey(), command.userId().value(), order.getId());
    return order;
}
```

### 3. **ì¹´ë“œ ê²°ì œ 2-Phase ì²˜ë¦¬**
```java
@Override
public void pay(PaymentCommand cmd) {
    Long paymentId = createInitiated(cmd);     // Tx#1: ê²°ì œ ìƒì„±
    PgPaymentResponse resp = requestPg(cmd);   // noTx: PG í˜¸ì¶œ
    updateAfterPg(paymentId, resp);            // Tx#2: ê²°ê³¼ ì—…ë°ì´íŠ¸
}
```

### 4. **í¬ì¸íŠ¸ ê²°ì œ ë‹¨ì¼ íŠ¸ëœì­ì…˜**
```java
@Override
@Transactional
public void pay(PaymentCommand cmd) {
    // ì¤‘ë³µ ê²°ì œ ê°€ë“œ
    if (paymentRepository.existsCompleted(cmd.orderId(), PaymentMethod.POINT)) return;
    
    // í¬ì¸íŠ¸ ì°¨ê°
    pointService.deduct(cmd.userId(), amount);
    
    // ê²°ì œ ì™„ë£Œ ì²˜ë¦¬
    Payment completed = payment.withTransactionKey(txKey).completePayment("í¬ì¸íŠ¸ ê²°ì œ ì™„ë£Œ");
    Payment saved = paymentRepository.save(completed);
    
    // ì´ë²¤íŠ¸ ë°œí–‰
    eventPublisher.publishEvent(PaymentCompletedEvent.of(...));
}
```

### 5. **AFTER_COMMIT ì´ë²¤íŠ¸ ì²˜ë¦¬**
```java
@TransactionalEventListener(phase = TransactionPhase.AFTER_COMMIT)
public void onPaymentCompleted(PaymentCompletedEvent event) {
    orderTransactionService.handlePaymentCompleted(event);
}

@TransactionalEventListener(phase = TransactionPhase.AFTER_COMMIT)
public void onPaymentFailed(PaymentFailedEvent event) {
    orderTransactionService.handlePaymentFailed(event);
}
```

### 6. **ë³´ìƒ ë¡œì§ (ê²°ì œ ì‹¤íŒ¨ ì‹œ)**
```java
@Transactional
public void handlePaymentFailed(PaymentFailedEvent event) {
    Order order = orderService.getOrder(event.orderId());
    orderService.markPaymentFailed(order, event.reason());
    compensationService.reverseFor(order.getId()); // ì¬ê³ /ì¿ í° ë³µì›
}

@Transactional
public void reverseFor(Long orderId) {
    productService.restoreByOrderId(orderId);  // ì¬ê³  ë³µì›
    couponService.releaseByOrderId(orderId);   // ì¿ í° í•´ì œ
}
```

## ì£¼ìš” ê°œì„ ì‚¬í•­

### âœ… 1. **íŠ¸ëœì­ì…˜ ë¶„ë¦¬**
- ì£¼ë¬¸ ìƒì„±ê³¼ ê²°ì œ ì²˜ë¦¬ë¥¼ ë¶„ë¦¬
- ì¹´ë“œ ê²°ì œì˜ PG í˜¸ì¶œì„ íŠ¸ëœì­ì…˜ ë°–ìœ¼ë¡œ ì´ë™
- ê° íŠ¸ëœì­ì…˜ì˜ í¬ê¸°ë¥¼ ìµœì†Œí™”

### âœ… 2. **ì´ë²¤íŠ¸ ê¸°ë°˜ ë¹„ë™ê¸° ì²˜ë¦¬**
- `@TransactionalEventListener(AFTER_COMMIT)` ì‚¬ìš©
- ê²°ì œ ì™„ë£Œ/ì‹¤íŒ¨ í›„ ì£¼ë¬¸ ìƒíƒœ ë³€ê²½
- íŠ¸ëœì­ì…˜ ì»¤ë°‹ í›„ ì•ˆì „í•œ ì´ë²¤íŠ¸ ì²˜ë¦¬

### âœ… 3. **ë³´ìƒ ë¡œì§ ë„ì…**
- ê²°ì œ ì‹¤íŒ¨ ì‹œ ìë™ìœ¼ë¡œ ì¬ê³ /ì¿ í° ë³µì›
- ë°ì´í„° ì •í•©ì„± ë³´ì¥

### âœ… 4. **ëª…í™•í•œ ë„¤ì´ë°**
- `savePending` â†’ `saveReceived`
- `markSuccess` â†’ `markAccepted`
- ë¹„ì¦ˆë‹ˆìŠ¤ ì˜ë¯¸ê°€ ë” ëª…í™•í•¨

### âœ… 5. **ë©±ë“±ì„± ë³´ì¥**
- idempotencyKeyë¥¼ í†µí•œ ì¤‘ë³µ ìš”ì²­ ë°©ì§€
- ê° ê²°ì œ ë°©ì‹ë³„ ì¤‘ë³µ ì²˜ë¦¬ ë¡œì§

## í…ŒìŠ¤íŠ¸ ì‹œë‚˜ë¦¬ì˜¤

### ğŸ“‹ **ì‹œë‚˜ë¦¬ì˜¤ 1: í¬ì¸íŠ¸ ê²°ì œ ì„±ê³µ**
1. ì£¼ë¬¸ ìƒì„± â†’ ì¬ê³ ì°¨ê° â†’ ì¿ í°ì ìš© â†’ RECEIVED ê¸°ë¡
2. í¬ì¸íŠ¸ ì°¨ê° â†’ ê²°ì œ ì™„ë£Œ â†’ PaymentCompletedEvent ë°œí–‰
3. AFTER_COMMIT â†’ ì£¼ë¬¸ ìƒíƒœ PAIDë¡œ ë³€ê²½

### ğŸ“‹ **ì‹œë‚˜ë¦¬ì˜¤ 2: ì¹´ë“œ ê²°ì œ ì„±ê³µ**
1. ì£¼ë¬¸ ìƒì„± â†’ ì¬ê³ ì°¨ê° â†’ ì¿ í°ì ìš© â†’ RECEIVED ê¸°ë¡
2. ê²°ì œ INITIATED ìƒì„± â†’ PG í˜¸ì¶œ â†’ PROCESSING ìƒíƒœ ë³€ê²½
3. PG ì½œë°± â†’ PaymentCompletedEvent ë°œí–‰
4. AFTER_COMMIT â†’ ì£¼ë¬¸ ìƒíƒœ PAIDë¡œ ë³€ê²½

### ğŸ“‹ **ì‹œë‚˜ë¦¬ì˜¤ 3: ê²°ì œ ì‹¤íŒ¨ + ë³´ìƒ**
1. ì£¼ë¬¸ ìƒì„± â†’ ì¬ê³ ì°¨ê° â†’ ì¿ í°ì ìš©
2. ê²°ì œ ì‹¤íŒ¨ â†’ PaymentFailedEvent ë°œí–‰
3. AFTER_COMMIT â†’ ì£¼ë¬¸ ì‹¤íŒ¨ + ì¬ê³ /ì¿ í° ë³µì›

### ğŸ“‹ **ì‹œë‚˜ë¦¬ì˜¤ 4: ë©±ë“±ì„± í…ŒìŠ¤íŠ¸**
1. ê°™ì€ idempotencyKeyë¡œ ì¬ìš”ì²­
2. ê¸°ì¡´ ì£¼ë¬¸ ì •ë³´ ë°˜í™˜ (ì¤‘ë³µ ì²˜ë¦¬ ì—†ìŒ)
